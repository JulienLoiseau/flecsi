

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Example 6: Sparse Data &mdash; FleCSI 2.-1 (devel) documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  
    <link rel="canonical" href="https://flecsi.orgsrc/tutorial/sparse.html"/>
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/flecsi.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                Version: 2.-1 (devel)
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build.html">Build &amp; Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer-guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-guide.html">Core Guide</a></li>
<li class="toctree-l1"><a class="reference external" href="http://laristra.github.io/flecsi/doxygen">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../team.html">Contributors</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">FleCSI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Example 6: Sparse Data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/src/tutorial/sparse.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="example-6-sparse-data">
<h1>Example 6: Sparse Data<a class="headerlink" href="#example-6-sparse-data" title="Permalink to this headline">Â¶</a></h1>
<p>The FleCSI sparse storage class allows the representation of sparse data
fields, i.e., fields on which zero, one or more data may be defined at
each index of the associated index space. The sparse storage class is
suitable for representing sparse matrices, sparse materials, or any
other logical data structure that utilizes a compressed storage
appraoch. <em>Note that although the current implementation does use a
compressed storage scheme, there is no guaruntee that this will be the
case.</em> The sparse storage class defines the interface to the registered
field data, not the storage mechanism.</p>
<p>Sparse storage differs from simple contiguous data in that, not only are
the data at each index mutable, but the sparsity pattern of the data is
also mutable. Modifying the sparsity pattern of the data is a more
expensive operation than simply modifying the values of existing sparse
data. To allow for more efficient access patterns, FleCSI splits
operations that mutate the sparsity pattern from those that only modify
the data (without changing the sparsity pattern). Access to these is
defined using separate types:</p>
<ol class="arabic simple">
<li><p>A mutator allows <em>both</em> modification of the sparsity structure and
of the data values.</p></li>
<li><p>A handle only allows modification to the data values.</p></li>
</ol>
<p>The data handle interface is the same as for <em>dense</em> data. For the
mutator, the user must specify an additional argument that declares how
many slots should be pre-allocated for adding new non-sparse entries:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">//                                                                v</span>
<span class="k">auto</span> <span class="n">f</span> <span class="o">=</span> <span class="n">flecsi_get_mutator</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="n">sparse</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</pre></div>
</div>
<p>This argument is only a hint to the runtime: Slots added within this
allocation will be more efficient than those that exceed the allocation.
However, both operations will be correct, i.e., if the user has
specified 5 additional slots, but adds 6 non-sparse entries, the program
will still operate correctly. (FleCSI uses an overflow buffer to manage
additional entries that exceed the slot allocation.)</p>
<p>NOTES:</p>
<ul class="simple">
<li><p>Tasks that do not need to mutate the sparsity structure should always
use an <em>handle</em> rather than a <em>mutator</em> for efficiency.</p></li>
<li><p>We are investigating design changes that will allow specialization
developers to add new storage classes and storage class
implementations.</p></li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="cpf">&lt;flecsi/tutorial/specialization/mesh/mesh.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;flecsi/data/data.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;flecsi/execution/execution.h&gt;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">flecsi</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">flecsi</span><span class="o">::</span><span class="n">tutorial</span><span class="p">;</span>

<span class="c1">// Field registration is as usual (but specifying the &#39;sparse&#39;</span>
<span class="c1">// storage class).</span>

<span class="n">flecsi_register_field</span><span class="p">(</span><span class="n">mesh_t</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="n">sparse</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cells</span><span class="p">);</span>

<span class="k">namespace</span> <span class="n">example</span> <span class="p">{</span>

<span class="c1">// This task takes a mesh and a sparse mutator and randomly populates</span>
<span class="c1">// field entries into the sparse field structure.</span>

<span class="kt">void</span> <span class="n">initialize_sparse_field</span><span class="p">(</span><span class="n">mesh</span><span class="o">&lt;</span><span class="n">ro</span><span class="o">&gt;</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">sparse_field_mutator</span> <span class="n">f</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">c</span><span class="p">:</span> <span class="n">mesh</span><span class="p">.</span><span class="n">cells</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">random</span> <span class="o">=</span> <span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="o">/</span><span class="kt">double</span><span class="p">{</span><span class="n">RAND_MAX</span><span class="p">})</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">random</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const</span> <span class="kt">size_t</span> <span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="o">/</span><span class="kt">double</span><span class="p">{</span><span class="n">RAND_MAX</span><span class="p">})</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>

      <span class="c1">// Note that the field operator () takes a cell index and</span>
      <span class="c1">// an entry. This provides logically dense access to sparsley</span>
      <span class="c1">// stored data.</span>

      <span class="n">f</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

    <span class="p">}</span> <span class="c1">// for</span>
  <span class="p">}</span> <span class="c1">// for</span>
<span class="p">}</span> <span class="c1">// initialize_pressure</span>

<span class="n">flecsi_register_task</span><span class="p">(</span><span class="n">initialize_sparse_field</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">single</span><span class="p">);</span>

<span class="c1">// This task prints the non-zero entries of the sparse field.</span>

<span class="kt">void</span> <span class="nf">print_sparse_field</span><span class="p">(</span><span class="n">mesh</span><span class="o">&lt;</span><span class="n">ro</span><span class="o">&gt;</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">sparse_field</span><span class="o">&lt;</span><span class="n">ro</span><span class="o">&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">c</span><span class="p">:</span> <span class="n">mesh</span><span class="p">.</span><span class="n">cells</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">m</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="n">entries</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">f</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="c1">// for</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span> <span class="c1">// for</span>
<span class="p">}</span> <span class="c1">// print_pressure</span>

<span class="n">flecsi_register_task</span><span class="p">(</span><span class="n">print_sparse_field</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">single</span><span class="p">);</span>

<span class="p">}</span> <span class="c1">// namespace example</span>

<span class="k">namespace</span> <span class="n">flecsi</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">execution</span> <span class="p">{</span>

<span class="kt">void</span> <span class="n">driver</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Get a handle to the mesh</span>

  <span class="k">auto</span> <span class="n">m</span> <span class="o">=</span> <span class="n">flecsi_get_client_handle</span><span class="p">(</span><span class="n">mesh_t</span><span class="p">,</span> <span class="n">clients</span><span class="p">,</span> <span class="n">mesh</span><span class="p">);</span>

  <span class="p">{</span>
  <span class="c1">// Get a mutator to modify the sparsity structure of the data.</span>

  <span class="k">auto</span> <span class="n">f</span> <span class="o">=</span> <span class="n">flecsi_get_mutator</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="n">sparse</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

  <span class="n">flecsi_execute_task</span><span class="p">(</span><span class="n">initialize_sparse_field</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">single</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
  <span class="p">}</span> <span class="c1">// scope</span>

  <span class="p">{</span>
  <span class="c1">// Get a handle to modify only the values of the data.</span>

  <span class="k">auto</span> <span class="n">f</span> <span class="o">=</span> <span class="n">flecsi_get_handle</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="n">sparse</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="n">flecsi_execute_task</span><span class="p">(</span><span class="n">print_sparse_field</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">single</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
  <span class="p">}</span> <span class="c1">// scope</span>

<span class="p">}</span> <span class="c1">// driver</span>

<span class="p">}</span> <span class="c1">// namespace execution</span>
<span class="p">}</span> <span class="c1">// namespace flecsi</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016 Los Alamos National Laboratory, LLC

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    

  <style>
    /* Contents caption */
    .wy-menu-vertical>p.caption {
      color: #ffffff;
    }

    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #e3e2db;
    }
    .wy-side-nav-search>div.version, .wy-nav-top>div.version {
      color: #5f5d5f;
    }

    /* Sidebar */
    .wy-nav-side {
      background: #216897;
      color: #ffffff;
    }
  </style>


</body>
</html>