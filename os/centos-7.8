#------------------------------------------------------------------------------#
# FleCSI CI Configuration for CentOS 7.8
#------------------------------------------------------------------------------#

FROM centos:7.8.2003

#------------------------------------------------------------------------------#
# Install basic linux requirements
#------------------------------------------------------------------------------#

RUN yum update -y && yum install -y \
  bzip2 \
  clang \
  cmake \
  doxygen \
  flex \
  gcc \
  gcc-c++ \
  gcc-gfortran \
  git \
  make \
  ncurses-devel \
  lbzip2 \
  passwd \
  patch \
  python3 \
  sudo \
  unzip \
  vim-enhanced \
  wget \
  which

#------------------------------------------------------------------------------#
# Build gcc 9
#------------------------------------------------------------------------------#

ADD gnu-centos-7.8.tbz /

#RUN wget http://ftpmirror.gnu.org/gcc/gcc-9.3.0/gcc-9.3.0.tar.xz
#RUN tar xf gcc-9.3.0.tar.xz
#
#WORKDIR gcc-9.3.0
#RUN contrib/download_prerequisites
#RUN ./configure --disable-multilib --enable-languages=c,c++,fortran \
#  --prefix=/opt/gnu/9.3.0
#RUN make
#RUN make install
#
#WORKDIR /
#RUN rm -rf gcc-9.3.0*

#------------------------------------------------------------------------------#
# Build ccache
#------------------------------------------------------------------------------#

RUN wget https://github.com/ccache/ccache/releases/download/v3.7.9/ccache-3.7.9.tar.xz
RUN tar xf ccache-3.7.9.tar.xz

WORKDIR ccache-3.7.9
RUN ./configure --prefix=/opt/ccache/3.7.9
RUN make
RUN make install

WORKDIR /
RUN rm -rf ccache-3.7.9

#------------------------------------------------------------------------------#
# Set root prompt
#------------------------------------------------------------------------------#

RUN echo "PS1=\"\[\033[1;31m\]root \[\e[38;5;160m\]>\[\e[38;5;166m\]>\[\e[38;5;172m\]>\[\033[0m\] \"" >> /root/.bashrc

#------------------------------------------------------------------------------#
# Add flecsi user
#------------------------------------------------------------------------------#

RUN groupadd -r flecsi
RUN useradd -r -m -g flecsi flecsi
RUN echo "flecsi ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/flecsi

USER flecsi
WORKDIR /home/flecsi

RUN \
  echo "syntax on" > .vimrc && \
  echo "set background=dark" >> .vimrc && \
  echo "highlight Comment cterm=italic" >> .vimrc

#------------------------------------------------------------------------------#
# Setup path for gcc 9
#------------------------------------------------------------------------------#

ENV PATH /opt/gnu/9.3.0/bin:/opt/ccache/3.7.9/bin:$PATH
ENV LD_LIBRARY_PATH /opt/gnu/9.3.0/lib:/opt/gnu/9.3.0/lib64:$LD_LIBRARY_PATH

#------------------------------------------------------------------------------#
# Capture version information
#------------------------------------------------------------------------------#

RUN yum info ncurses | grep -m 1 Version | \
  awk '{ print $3 }' > .ncurses_version
RUN gcc -v 2>&1 | grep "gcc version" | awk '{ print $3 }' > .gnu_version

#------------------------------------------------------------------------------#
# Install pip packages
#------------------------------------------------------------------------------#

RUN pip3 install --user pyyaml
RUN pip3 install --user Sphinx
RUN pip3 install --user recommonmark
RUN pip3 install --user sphinx_rtd_theme

#------------------------------------------------------------------------------#
# Set default shell for interactive
#------------------------------------------------------------------------------#

CMD /bin/bash

# vim: syntax=dockerfile
