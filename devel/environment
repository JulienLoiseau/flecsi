#------------------------------------------------------------------------------#
# FleCSI CI Configuration for Environment
#------------------------------------------------------------------------------#

ARG OS
FROM ${OS}

#------------------------------------------------------------------------------#
# Clone repositories
#------------------------------------------------------------------------------#

ARG REPO
ARG BRANCH

RUN git clone --single-branch --branch ${BRANCH} ${REPO} ${BRANCH}
RUN git clone --single-branch \
  --branch develop https://github.com/spack/spack.git

#------------------------------------------------------------------------------#
# Setup spack configuration
#------------------------------------------------------------------------------#

ARG VERSIONING

RUN mkdir -p .spack/linux && \
  export GNU_VERSION=`cat .gnu_version` && \
  export NCURSES_VERSION=`cat .ncurses_version` && \
  cat ${BRANCH}/${VERSIONING}/spack/packages.yaml | \
    sed "s,GNU_VERSION,${GNU_VERSION},g" | \
    sed "s,NCURSES_VERSION,${NCURSES_VERSION},g" > .spack/linux/packages.yaml

RUN . spack/share/spack/setup-env.sh && \
  spack compiler find

#------------------------------------------------------------------------------#
# Add gfortran to clang
#------------------------------------------------------------------------------#

ADD clang_fortran.py ./clang_fortran.py
RUN export GNU_VERSION=`cat .gnu_version` && \
  /home/flecsi/clang_fortran.py '.spack/linux/compilers.yaml' '.spack/linux/compilers.yaml' "${GNU_VERSION}"

#------------------------------------------------------------------------------#
# Install generic packages
#------------------------------------------------------------------------------#

RUN . spack/share/spack/setup-env.sh && \
  spack fetch --dependencies boost && \
  spack install boost

RUN . spack/share/spack/setup-env.sh && \
  spack fetch --dependencies graphviz && \
  spack install graphviz

#------------------------------------------------------------------------------#
# Create MPICH environment
#------------------------------------------------------------------------------#

RUN . spack/share/spack/setup-env.sh && \
  spack fetch --dependencies mpich && \
  spack install mpich

RUN . spack/share/spack/setup-env.sh && \
  spack fetch --dependencies gasnet^mpich && \
  spack install gasnet^mpich

RUN . spack/share/spack/setup-env.sh && \
  spack fetch --dependencies parmetis^mpich && \
  spack install parmetis^mpich

RUN . spack/share/spack/setup-env.sh && \
  spack env create ${VERSIONING}-mpich && \
  spack env activate ${VERSIONING}-mpich && \
  spack install cmake mpich gasnet^mpich parmetis^mpich boost graphviz

#------------------------------------------------------------------------------#
# Create OpenMPI environment
#------------------------------------------------------------------------------#

RUN . spack/share/spack/setup-env.sh && \
  spack fetch --dependencies openmpi && \
  spack install openmpi

RUN . spack/share/spack/setup-env.sh && \
  spack fetch --dependencies gasnet^openmpi && \
  spack install gasnet^openmpi

RUN . spack/share/spack/setup-env.sh && \
  spack fetch --dependencies parmetis^openmpi && \
  spack install parmetis^openmpi

RUN . spack/share/spack/setup-env.sh && \
  spack env create ${VERSIONING}-openmpi && \
  spack env activate ${VERSIONING}-openmpi && \
  spack install cmake openmpi gasnet^openmpi parmetis^openmpi boost graphviz

#------------------------------------------------------------------------------#
# Set default shell for interactive
#------------------------------------------------------------------------------#

RUN echo "export PATH=$HOME/.local/bin:$PATH" > .bashrc
RUN echo "source spack/share/spack/setup-env.sh" >> .bashrc

CMD /bin/bash

# vim: syntax=dockerfile
